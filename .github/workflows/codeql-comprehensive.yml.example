name: CodeQL Comprehensive Analysis

# This is a more thorough version that:
# 1. Builds more targets
# 2. Includes test code
# 3. Uses security-and-quality query suite
# 4. Analyzes both architectures
#
# Rename to .yml to enable (slower but more thorough)

on:
  schedule:
    # Run monthly on first day at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  analyze:
    name: Comprehensive CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['cpp']
        arch: ['x86_64', 'aarch64']

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # Use security-and-quality for maximum coverage
          queries: security-and-quality
          config: |
            paths-ignore:
              - third_party/**
            # Include everything else, even tests
            paths:
              - libc/**
              - tool/**
              - ape/**
              - dsp/**
              - net/**
              - test/**

      - name: Setup APE support
        run: |
          sudo cp build/bootstrap/ape.elf /usr/bin/ape
          sudo sh -c "echo ':APE:M::MZqFpD::/usr/bin/ape:' >/proc/sys/fs/binfmt_misc/register"

      - name: Build comprehensive targets
        run: |
          make -j$(nproc) m=${{ matrix.arch }} \
            o/${{ matrix.arch }}/ape/ape.elf \
            o/${{ matrix.arch }}/tool/lua/lua.dbg \
            o/${{ matrix.arch }}/tool/lua/test \
            o/${{ matrix.arch }}/third_party/make/make.dbg \
            o/${{ matrix.arch }}/third_party/zip/zip.dbg \
            o/${{ matrix.arch }}/third_party/unzip/unzip.dbg \
            o/${{ matrix.arch }}/libc/libc.a

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}/arch:${{ matrix.arch }}"
          upload: true
